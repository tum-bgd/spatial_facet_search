<!DOCTYPE html>
<html>
<head>
  <meta charset='utf-8'>
  <meta name="viewport" content="width=device-width,height=device-height, user-scalable=no" />
  <title>Spatial Facet Search Demo</title>
  <link rel="stylesheet" href="https://npmcdn.com/leaflet@1.3.4/dist/leaflet.css" />
  <script src="https://npmcdn.com/leaflet@1.3.4/dist/leaflet.js"></script>
  <script src="https://npmcdn.com/leaflet.path.drag/src/Path.Drag.js"></script>
  <script src="js/Leaflet.Editable.js"></script>
  <script src='https://unpkg.com/@turf/turf@6.3.0/turf.min.js'></script>
  <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js" type="text/javascript"></script>

  <style type='text/css'>
      body { margin:0; padding:0; }
      #map { height:500px; }
      h1 { text-align:center; font-size: 15px;}
      #query {width:80%;}
      .centered {text-align:center;}
      #proposed_keywords {height:3em; overflow:scroll}
</style>
</head>

<body>
  <div id='header'>
    <h1> Search</h1>
    <div class="centered"><input type="text" id="query" value="apple"/></div>
    <button id='btnSetFacetToView' onClick='setFacetToView()'>Facet View</button>
    <button id='btnSupervisedFacet' onClick='supervised_facet()'>Supervised Spatial Facet...</button>
    <HR/>
    <div id="proposed_keywords">
    </div>
 <div id='map'></div>
 
 <script type="text/javascript">
   var U= 0;

   function createPolygonFromBounds(latLngBounds) {
       var center = latLngBounds.getCenter()
       latlngs = [];

       latlngs.push(latLngBounds.getSouthWest());//bottom left
       //latlngs.push({ lat: latLngBounds.getSouth(), lng: center.lng });//bottom center
       latlngs.push(latLngBounds.getSouthEast());//bottom right
      // latlngs.push({ lat: center.lat, lng: latLngBounds.getEast() });// center right
       latlngs.push(latLngBounds.getNorthEast());//top right
      // latlngs.push({ lat: latLngBounds.getNorth(), lng: map.getCenter().lng });//top center
       latlngs.push(latLngBounds.getNorthWest());//top left
       //latlngs.push({ lat: map.getCenter().lat, lng: latLngBounds.getWest() });//center left
       console.log(latlngs)
       return L.polygon(latlngs);
}

   function setFacetToView()
   {
     if(typeof poly !== "undefined")
       {
	   poly.remove()
       }
       poly = createPolygonFromBounds(map.getBounds()).addTo(map)
       poly.enableEdit();
       poly.on('dblclick', L.DomEvent.stop).on('dblclick', poly.toggleEdit);
 /*       poly = L.polygon(buffer["geometry"]["coordinates"]).addTo(map);
       poly.enableEdit();
       poly.on('dblclick', L.DomEvent.stop).on('dblclick', poly.toggleEdit);
  */
   }


   
   function inspect(){
       
       alert(JSON.stringify(line.toGeoJSON()));
   }

   const supervised_facet = function(){
       $.ajax({
	   url:"/supervised_facet",
	   type:"POST",
	   data:JSON.stringify({"query":$("#query").val(), "poly": poly.toGeoJSON()}),
	   contentType:"application/json; charset=utf-8",
	   dataType:"json",
	   success: function(data){
	       console.log(data["aug_keywords"])
	       <!DOCTYPE html>
<html>
<head>
  <meta charset='utf-8'>
  <meta name="viewport" content="width=device-width,height=device-height, user-scalable=no" />
  <title>Spatial Facet Search Demo</title>
  <link rel="stylesheet" href="https://npmcdn.com/leaflet@1.3.4/dist/leaflet.css" />
  <script src="https://npmcdn.com/leaflet@1.3.4/dist/leaflet.js"></script>
  <script src="https://npmcdn.com/leaflet.path.drag/src/Path.Drag.js"></script>
  <script src="js/Leaflet.Editable.js"></script>
  <script src='https://unpkg.com/@turf/turf@6.3.0/turf.min.js'></script>
  <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js" type="text/javascript"></script>

  <style type='text/css'>
      body { margin:0; padding:0; }
      #map { height:500px; }
      h1 { text-align:center; font-size: 15px;}
      #query {width:80%;}
      .centered {text-align:center;}
      #proposed_keywords {height:3em; overflow:scroll}
</style>
</head>

<body>
  <div id='header'>
    <h1> Search</h1>
    <div class="centered"><input type="text" id="query" value="apple"/></div>
    <button id='btnSetFacetToView' onClick='setFacetToView()'>Facet View</button>
    <button id='btnSupervisedFacet' onClick='supervised_facet()'>Supervised Spatial Facet...</button>
    <HR/>
    <div id="proposed_keywords">
    </div>
 <div id='map'></div>
 
 <script type="text/javascript">
   var U= 0;

   function createPolygonFromBounds(latLngBounds) {
       var center = latLngBounds.getCenter()
       latlngs = [];

       latlngs.push(latLngBounds.getSouthWest());//bottom left
       //latlngs.push({ lat: latLngBounds.getSouth(), lng: center.lng });//bottom center
       latlngs.push(latLngBounds.getSouthEast());//bottom right
      // latlngs.push({ lat: center.lat, lng: latLngBounds.getEast() });// center right
       latlngs.push(latLngBounds.getNorthEast());//top right
      // latlngs.push({ lat: latLngBounds.getNorth(), lng: map.getCenter().lng });//top center
       latlngs.push(latLngBounds.getNorthWest());//top left
       //latlngs.push({ lat: map.getCenter().lat, lng: latLngBounds.getWest() });//center left
       console.log(latlngs)
       return L.polygon(latlngs);
}

   function setFacetToView()
   {
     if(typeof poly !== "undefined")
       {
	   poly.remove()
       }
       poly = createPolygonFromBounds(map.getBounds()).addTo(map)
       poly.enableEdit();
       poly.on('dblclick', L.DomEvent.stop).on('dblclick', poly.toggleEdit);
 /*       poly = L.polygon(buffer["geometry"]["coordinates"]).addTo(map);
       poly.enableEdit();
       poly.on('dblclick', L.DomEvent.stop).on('dblclick', poly.toggleEdit);
  */
   }


   
   function inspect(){
       
       alert(JSON.stringify(line.toGeoJSON()));
   }

   const supervised_facet = function(){
       $.ajax({
	   url:"/supervised_facet",
	   type:"POST",
	   data:JSON.stringify({"query":$("#query").val(), "poly": poly.toGeoJSON()}),
	   contentType:"application/json; charset=utf-8",
	   dataType:"json",
	   success: function(data){
	       console.log(data["aug_keywords"])
	       var the_text ="<ul>"
	       data["aug_keywords"].forEach( function(element)
					     {
						 weight = element[1].toFixed(2);
						 kw = element[0]
						 the_text += `<li>${weight}: ${element[0]}</li>`
					     })
	       the_text += "</ul>"

	       $("#proposed_keywords").html(the_text) //("lala" + data["aug_keywords"]);
//	       alert( "Data Loaded: " + data["query"] );
	   }
       })		 
       console.log('planning')
   }   

const flip = arr => {
   for (let i = 0; i < arr.length; i++) {
         const tmp = arr[i][0];
         arr[i][0] = arr[i][1];
         arr[i][1] = tmp;
   }
} 
   var poly = undefined;

   function buffering(){
       
       l_as_geojson =line.toGeoJSON()
       flip(l_as_geojson["geometry"]["coordinates"])
       // is 11, 48, should become 48,11
       
       
       var buffer = turf.buffer(l_as_geojson, 150, {units: 'meters'});
       console.log(buffer)
       // remove poly if exists
       if(typeof poly !== "undefined")
       {
	   poly.remove()
       }
       poly = L.polygon(buffer["geometry"]["coordinates"]).addTo(map);
       poly.enableEdit();
       poly.on('dblclick', L.DomEvent.stop).on('dblclick', poly.toggleEdit);
  
   }
   
   
  var startPoint = [52.1249, 11.5];
   var startLine = [[48.142838,11.527362],[48.140833,11.55427]];
var map = L.map('map', {editable: true}).setView(startPoint, 6),
    tilelayer = L.tileLayer('http://{s}.tile.openstreetmap.fr/hot/{z}/{x}/{y}.png', {maxZoom: 20, attribution: 'Data \u00a9 <a href="http://www.openstreetmap.org/copyright"> OpenStreetMap Contributors </a> Tiles \u00a9 HOT'}).addTo(map);

    L.EditControl = L.Control.extend({

        options: {
            position: 'topleft',
            callback: null,
            kind: '',
            html: ''
        },

        onAdd: function (map) {
            var container = L.DomUtil.create('div', 'leaflet-control leaflet-bar'),
                link = L.DomUtil.create('a', '', container);

            link.href = '#';
            link.title = 'Create a new ' + this.options.kind;
            link.innerHTML = this.options.html;
            L.DomEvent.on(link, 'click', L.DomEvent.stop)
                      .on(link, 'click', function () {
                        window.LAYER = this.options.callback.call(map.editTools);
                      }, this);

            return container;
        }

    });

    L.NewLineControl = L.EditControl.extend({

        options: {
            position: 'topleft',
            callback: map.editTools.startPolyline,
            kind: 'line',
            html: '\\/\\'
        }

    });

    L.NewPolygonControl = L.EditControl.extend({

        options: {
            position: 'topleft',
            callback: map.editTools.startPolygon,
            kind: 'polygon',
            html: 'â–°'
        }

    });

    L.NewMarkerControl = L.EditControl.extend({

        options: {
            position: 'topleft',
            callback: map.editTools.startMarker,
            kind: 'marker',
            html: 'ðŸ–ˆ'
        }

    });

    L.NewRectangleControl = L.EditControl.extend({

        options: {
            position: 'topleft',
            callback: map.editTools.startRectangle,
            kind: 'rectangle',
            html: 'â¬›'
        }

    });

    L.NewCircleControl = L.EditControl.extend({

        options: {
            position: 'topleft',
            callback: map.editTools.startCircle,
            kind: 'circle',
            html: 'â¬¤'
        }

    });

/*    map.addControl(new L.NewMarkerControl());
#    map.addControl(new L.NewLineControl());
#    map.addControl(new L.NewPolygonControl());
#    map.addControl(new L.NewRectangleControl());
    map.addControl(new L.NewCircleControl());
*/
    var line = L.polyline(startLine).addTo(map);
    line.enableEdit();
    line.on('dblclick', L.DomEvent.stop).on('dblclick', line.toggleEdit);




</script>
</body>
</html>
